var YBWidget = function () {
    this.head = document.getElementsByTagName('head')[0];
    this.body = document.getElementsByTagName('body')[0];

    this.init();
};

YBWidget.prototype.openWidget = function () {
    var _this = this;

    this.widget = document.createElement('div');
    this.widget.className = 'yb-overlay';

    this.iframe = document.createElement('iframe');
    this.iframe.src = this.url;
    this.iframe.allowtransparency = true;
    this.iframe.className = 'yb-iframe';

    this.widget.appendChild(this.iframe);
    this.body.appendChild(this.widget);

    this.preventWindowScroll();
};

YBWidget.prototype.widgetSize = function (props) {
    this.iframe.style.height = props.height + 'px';
};

YBWidget.prototype.widgetPosition = function (props) {
    var left = (this.widget.offsetWidth - props.width) / 2;
    var top = (this.widget.offsetHeight - props.height) / 2;

    left = left < 0 ? 0 : left;
    top = top < 0 ? 0 : top;

    this.iframe.style.left = left + 'px';
    this.iframe.style.top = top + 'px';
};

YBWidget.prototype.closeWidget = function () {
    this.body.removeChild(this.widget);

    $(window).off('scroll.yb');
};

YBWidget.prototype.preventWindowScroll = function () {
    var scrollTop = $(window).scrollTop();
    $(window).on('scroll.yb', function () {
        $(window).scrollTop(scrollTop);
    });
};

YBWidget.prototype.init = function () {
    var _this = this;

    var cssRules = {
        '.yb-button-red': 'display:inline-block;height:16px;padding:4px 10px;font-size:12px;color:#fff;text-decoration:none;background-color:#f5434c;-webkit-border-radius:2px;border-radius:2px;',
        '.yb-overlay': 'position: fixed;left: 0;top: 0;right: 0;bottom: 0;z-index: 10000;overflow: auto;background-color: rgba(0, 0, 0, 0.7);',
        '.yb-iframe': 'position: absolute;top: -9999px;width: 340px;max-width:100%;border: none;-webkit-border-radius: 2px;border-radius: 2px; -webkit-box-shadow: 0 2px 4px rgba(0,0,0,0.15);box-shadow: 0 2px 4px rgba(0,0,0,0.15);'
    };
    var styleTag = document.createElement('style');
    this.head.insertBefore(styleTag, this.head.firstChild);
    var sheet = styleTag.sheet ? styleTag.sheet : styleTag.styleSheet;

    for (var i in cssRules) {
        if (sheet.insertRule) {
            sheet.insertRule (i + ' {' + cssRules[i] + '}', 0);
        }
        else {
            if (sheet.addRule) {
                sheet.addRule (i, cssRules[i], 0);
            }
        }
    }

    $.fn.YBWidget = function () {
        $(this).filter(function () {
            return !$(this).data('yb-inited');
        }).each(function() {
            var $this = $(this);

            if ($this.find('.yb-widget').length) {
                _this.initWidget($this.find('.yb-widget'));
                $this.data('yb-inited', true);
                return;
            }

            $.get($this.data('yb-widget'))
                .done(function (response) {
                    $this.html(response);
                    _this.initWidget($this.find('.yb-widget'));
                    $this.data('yb-inited', true);
                })
                .fail(function () {
                    $this.html('Что-то пошло не так. Попробуйте обновить страницу.');
                });
        });

        return this;
    };

    $.fn.YBButton = function () {
        $(this).filter(function () {
            return !$(this).data('yb-inited');
        }).each(function() {
            var $this = $(this);
            $this.data('yb-inited', true).on('click', function (e) {
                e.preventDefault();
                if (window.yaCounter17147155) {
                    window.yaCounter17147155.reachGoal('ClickOnWidget');
                }

                _this.url = $this.attr('href') + '&popup=1';
                _this.openWidget();
            });
        });

        return this;
    };

    if (window.addEventListener) {
        window.addEventListener('message', function (event) {
            _this.onWindowMessage(event);
        });
    } else {
        window.attachEvent('onmessage', function (event) {
            _this.onWindowMessage(event);
        });
    }
};

YBWidget.prototype.initWidget = function ($widget) {
    var _this = this;
    var yellBooking = new YellBooking($widget);
    yellBooking.$form.on('submit', function (e) {
        e.preventDefault();
        e.stopPropagation();
        _this.url = $(this).attr('action') + '?' + $(this).serialize() + '&popup=1&step=2';

        yellBooking.registerEvent('ClickOnWidget');
        _this.openWidget();
    });
};

YBWidget.prototype.onWindowMessage = function (event) {
    var data = event.data;

    if (data.type == 'init') {
        this.widgetSize(event.data);
        this.widgetPosition(event.data);
    } else if (data.type == 'size') {
        this.widgetSize(event.data);
    } else if (data.type == 'close') {
        this.closeWidget();
    }
};

if (typeof jQuery === 'undefined') {
    var scriptTag = document.createElement('script');
    scriptTag.type = 'text/javascript';
    scriptTag.src = 'http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js';
    scriptTag.onload = function () {
        new YBWidget();
        $('.yb-button, [data-yb-button]').YBButton();
        $('[data-yb-widget]').YBWidget();
    };
    document.getElementsByTagName('head')[0].appendChild(scriptTag);
} else {
    new YBWidget();
    $('.yb-button, [data-yb-button]').YBButton();
    $('[data-yb-widget]').YBWidget();
}
